<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
<!ENTITY % entities SYSTEM "entity-decl.ent">
%entities;
]>
<chapter version="5.0" xml:id="accessing.kubernetes"
 xmlns="http://docbook.org/ns/docbook"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink">
 <info>
  <title>Interacting with &kube;</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker></dm:bugtracker>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 
 <sect1 xml:id="installing.kubectl">
  <title>Installing kubectl</title>
  <tip>
   <title>Installing kubectl on non-SUSE OS</title>
   <para>
    If you are using an operating system other than &sle; or &opensuse; please 
    consult the 
    <link xlink:href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">
    installation instructions</link> from the &kube; project.
   </para>
  </tip>
  <para>
   &kube; requires the use of <literal>kubectl</literal> for many tasks.
   You can perform most of these actions while logged in to an SSH session on 
   the master node of your &productname; cluster.
  </para>
  <para>
   One key exception is the use of <literal>kubectl proxy</literal>. 
   The proxy functionality requires <literal>kubectl</literal> to be installed 
   on your local machine to act as a proxy between the local workstation and the
    remote cluster.
  </para>
  <procedure>
   <title>Installing <literal>kubectl</literal> from the package repository</title>
   <step>
    <para>
     Go to <link xlink:href="https://build.opensuse.org/repositories/Virtualization:containers">the <filename>Virtualization:containers</filename> repository</link> and find the version of &sle;/&opensuse; you are using.
    </para>
   </step>
   <step>
    <para>
      Click the "Go to download repository" underneath your version.
     </para>
      <informalfigure>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="dl_repo_link.png" width="100%"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="dl_repo_link.png" width="100%"/>
        </imageobject>
       </mediaobject>
      </informalfigure>
   </step>
   <step>
    <para>
     Copy the URL to the repository from the URL bar of your browser. This is the location you will add as repository information in zypper.
    </para>
   </step>
   <step>
     <para>
      Open a terminal on your local machine add a repository to zypper:
     </para>
      <screen>
<command>zypper ar https://download.opensuse.org/repositories/Virtualization:/containers/SLE_12_SP3/</command>
      </screen>
      <para>
       You will have to trust the key signature for the repository to continue.
      </para>
   </step>  
   <step>
    <para>
     Refresh the repository information:
    </para>
    <screen><command>zypper ref</command></screen>
   </step>
   <step>
    <para>
     Install the <filename>kubernetes-client</filename> package:
    </para>
    <screen><command>zypper in kubernetes-client</command></screen>
   </step>
   <step>
    <para>
     To use kubectl to connect to a local machine you must perform <xref linkend="auth.kubeconfig" /> against the &kube; master node. Download the <filename>.kubeconfig</filename> file from &dashboard; and place it in <filename>Ëœ/.kube/config</filename>.
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="velum_kubeconfig.png" width="100%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="velum_kubeconfig.png" width="100%"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     Verify that <literal>kubectl</literal> was installed and is configured correctly:
    </para>
    <screen>
<command>kubectl get nodes</command>
NAME                  STATUS    ROLES     AGE       VERSION
caasp3-master     Ready     master    1d        v1.9.8
caasp3-worker-1   Ready     &lt;none&gt;    1d        v1.9.8
caasp3-worker-2   Ready     &lt;none&gt;    1d        v1.9.8
caasp3-worker-3   Ready     &lt;none&gt;    1d        v1.9.8
caasp3-worker-4   Ready     &lt;none&gt;    1d        v1.9.8
     </screen>
     <para>
     You should see the list of nodes known to &productname;.
    </para>
   </step>
 </procedure>

 </sect1>

 <sect1 xml:id="installing.kube.dashboard">
  <title>Installing &kube; Dashboard</title>
  
  <important>
   <title>Technology Preview</title>
   <para>
    Even though you can install and use the community &kube; dashboard,
    &suse; currently fully supports only &dashboard;.
   </para>
  </important>
  
  <itemizedlist>
   <title>Requirements</title>
   <listitem>
    <para>
     You need to have Heapster version 1.3.0 or later installed on the cluster.
     To verify it is installed run:
    </para>
    <screen>
<command>kubectl get pods</command> <option>--all-namespaces=true</option> <command>| grep heapster</command>
kube-system   heapster-default-heapster-659d4f8787-6vtkq   2/2       Running   0          2m
    </screen>
    <para>If you DO NOT get an output like above, you must install heapster first. See <xref linkend="installing.heapster" />
    </para>
   </listitem>
   <listitem>
    <para>
     &suse; recommends Helm version 2.7.2+ and <literal>kubectl</literal> version 1.9.0+.
    </para>
   </listitem>
   <listitem>
     <para>
       <literal>kubectl</literal> needs to be installed on the local machine and configured to talk to the remote &kube; API (CaaSP Master node). See <xref linkend="installing.kubectl" />
     </para>
   </listitem>
  </itemizedlist>
  
  <procedure>
   <title>Installation of &kube; Dashboard</title>
   <step>
    <para>
     Apply the <literal><link xlink:href="https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml">kubernetes-dashboard</link></literal> manifest from the &kube; GitHub project. This will automatically create the necessary services and RBAC settings to use the dashboard.
    </para>
    <screen>
<command>kubectl apply</command> <option>-f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</option>
secret "kubernetes-dashboard-certs" created
serviceaccount "kubernetes-dashboard" created
role.rbac.authorization.k8s.io "kubernetes-dashboard-minimal" created
rolebinding.rbac.authorization.k8s.io "kubernetes-dashboard-minimal" created
deployment.apps "kubernetes-dashboard" k8s_dashboard_login
service "kubernetes-dashboard" created
    </screen>
   </step>

   <step>
    <para>
     Run the <literal>kubectl proxy</literal> to establish a connection to the cluster.
    </para>
    <screen>
<command>kubectl proxy</command>
Starting to serve on 127.0.0.1:8001
    </screen>
   </step>   
   <step>
    <para>
     Visit <literal>http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</literal> in your browser. You will
     be greeted with by a welcome page containing a dialog to configure
     authentication.
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="k8s_dashboard_login.png" width="100%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="k8s_dashboard_login.png" width="100%"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     Retrieve the access token for your &productname; Admin user.
    </para>
    <screen>
<command>kubectl config view | grep id-token | awk '{ print $2 }'</command>
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTZnbDZsIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJiMTZhZmJhOS1kZmVjLTExZTctYmJiOS05MDFiMGU1MzI1MTYiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.M70CU3lbu3PP4OjhFms8PVL5pQKj-jj4RNSLA4YmQfTXpPUuxqXjiTf094_Rzr0fgN_IVX6gC4fiNUL5ynx9KU-lkPfk0HnX8scxfJNzypL039mpGt0bbe1IXKSIRaq_9VW59Xz-yBUhycYcKPO9RM2Qa1Ax29nqNVko4vLn1_1wPqJ6XSq3GYI8anTzV8Fku4jasUwjrws6Cn6_sPEGmL54sq5R4Z5afUtv-mItTmqZZdxnkRqcJLlg2Y8WbCPogErbsaCDJoABQ7ppaqHetwfM_0yMun6ABOQbIwwl8pspJhpplKwyo700OSpvTT9zlBsu-b35lzXGBRHzv5g_RA
    </screen>
   </step>
   <step>
    <para>
     Copy the access token, paste it into the input field and click <guimenu>SIGN IN</guimenu>. You will be forwarded to your &kube; dashboard.
    </para>
   </step>
   <step>
    <para>
     On login, cluster resources and basic metrics are populated.
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="k8s_dashboard_overview.png" width="100%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="k8s_dashboard_overview.png" width="100%"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
  </procedure>
  
 </sect1>
</chapter>
